<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Cadeia e Estrat√©gias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f7;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        th {
            cursor: pointer;
            position: sticky;
            top: 0;
            background-color: #1f2937;
            color: white;
            white-space: nowrap;
        }
        .call-row { background-color: #d1fae5; } 
        .put-row { background-color: #fee2e2; } 
        .input-text {
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
        }
        .text-right { text-align: right; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem 0.375rem 0 0;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-active {
            background-color: white;
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }
        .tab-inactive {
            background-color: #e5e7eb;
            color: #4b5563;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <header class="mb-6 bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Analisador Financeiro de Op√ß√µes</h1>
        <p class="text-gray-600">Explore dados de op√ß√µes e calcule o Payoff (Risco vs. Retorno) de estrat√©gias.</p>
    </header>

    <div class="flex border-b border-gray-300 mb-4">
        <div id="tabTable" class="tab-button tab-active" onclick="switchView('table')">Cadeia de Op√ß√µes</div>
        <div id="tabStrategy" class="tab-button tab-inactive" onclick="switchView('strategy')">Analisador de Estrat√©gias</div>
    </div>

    <!-- Reintroduzido o elemento que o JS espera para a aba 'tabela' (pode ficar vazio) -->
    <div id="tableView" class="hidden"></div>

    <!-- Substitui o bloco appContainer por layout mais limpo e UX-friendly
         Agora dentro de #strategyView para ser compat√≠vel com switchView() -->
    <div id="strategyView">
        <div id="appContainer" class="bg-white p-6 rounded-lg shadow-md">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Painel de controles (col 1) -->
                <aside class="lg:col-span-1 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="text-lg font-semibold mb-3">Par√¢metros do Mercado</h3>

                    <label class="block text-sm text-gray-600">Ativo Subjacente</label>
                    <div class="mb-3">
                        <input id="inputUnderlying" class="input-text w-full" value="BOVA11" />
                    </div>

                    <label class="block text-sm text-gray-600">Pre√ßo Atual (Spot)</label>
                    <div class="mb-3">
                        <input id="inputSpot" type="number" class="input-text w-full" value="100" step="0.01" />
                    </div>

                    <label class="block text-sm text-gray-600">Volatilidade (%)</label>
                    <div class="mb-3">
                        <input id="inputVol" type="number" class="input-text w-full" value="20" step="0.1" />
                    </div>

                    <label class="block text-sm text-gray-600">Taxa Livre de Risco (%)</label>
                    <div class="mb-3">
                        <input id="inputRFR" type="number" class="input-text w-full" value="10" step="0.01" />
                    </div>

                    <label class="block text-sm text-gray-600">Dias para o Vencimento</label>
                    <div class="mb-4">
                        <input id="inputDays" type="number" class="input-text w-full" value="30" />
                    </div>

                    <hr class="my-4">

                    <h4 class="text-md font-semibold mb-2">Adicionar Perna Manual</h4>
                    <div class="space-y-2 mb-3">
                        <div>
                            <label class="text-sm text-gray-600">Strike</label>
                            <input id="manualStrike" class="input-text w-full" placeholder="100.00" />
                        </div>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-sm text-gray-600">Tipo</label>
                                <select id="manualType" class="input-text w-full">
                                    <option>CALL</option>
                                    <option>PUT</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="text-sm text-gray-600">A√ß√£o</label>
                                <select id="manualAction" class="input-text w-full">
                                    <option>Compra (LONG)</option>
                                    <option>Venda (SHORT)</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input id="manualQty" type="number" class="input-text w-1/2" placeholder="Qtd. (lotes)" />
                            <input id="manualPremium" type="number" class="input-text w-1/2" placeholder="Pr√™mio" step="0.01" />
                        </div>
                        <button id="addLegBtn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Adicionar Perna</button>
                    </div>

                    <hr class="my-3">

                    <div class="text-sm text-gray-600">
                        <p><strong>Modo Otimizador:</strong></p>
                        <div class="flex items-center gap-2 mt-2">
                            <select id="optimizerMode" class="input-text w-full">
                                <option value="ranking">Ranking Otimizador (Top 5 por R/R)</option>
                                <option value="filter">Filtrar por Tipo</option>
                                <option value="all">Otimiza√ß√£o Geral (Todos os Spreads)</option>
                            </select>
                        </div>
                        <button id="runOptimizer" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Rodar Otimizador</button>
                    </div>
                </aside>

                <!-- Painel principal: lista de estrat√©gias + detalhe (col 2-4) -->
                <main class="lg:col-span-3 space-y-6">
                    <section>
                        <h2 class="text-xl font-semibold mb-3">Resultados do Otimizador</h2>
                        <div id="optimizerList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Cards de estrat√©gia gerados dinamicamente -->
                            <div class="strategy-card p-4 bg-white rounded-lg border shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold">1. Long Straddle K100 (D√©bito)</h3>
                                        <p class="text-sm text-gray-500">Risco/Recompensa e breakevens</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-700 font-medium">Score: <span class="text-indigo-600">‚àû</span></div>
                                        <div class="text-xs text-gray-500">Custo: R$ 10,42</div>
                                    </div>
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm view-strategy-btn">Ver</button>
                                    <button class="bg-gray-200 px-3 py-1 rounded text-sm add-to-portfolio-btn">Adicionar</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white p-4 rounded-lg border">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="lg:w-1/2">
                                <h3 class="text-lg font-semibold mb-2">Payoff no Vencimento</h3>
                                <canvas id="payoffChart" class="w-full h-64 bg-white"></canvas>
                                <div id="summary" class="mt-3 p-3 bg-indigo-50 rounded text-sm text-indigo-800 hidden"></div>
                            </div>
                            <div class="lg:w-1/2">
                                <h3 class="text-lg font-semibold mb-2">Detalhes da Estrat√©gia</h3>

                                <div id="strategyMetrics" class="grid grid-cols-2 gap-3 mb-4 text-sm">
                                    <div class="p-2 bg-gray-50 rounded">
                                        <div class="text-xs text-gray-500">Custo L√≠quido</div>
                                        <div id="metricCost" class="font-medium">R$ 10,42 (D√©bito)</div>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded">
                                        <div class="text-xs text-gray-500">Lucro M√°x.</div>
                                        <div id="metricMaxProfit" class="font-medium">Ilimitado</div>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded">
                                        <div class="text-xs text-gray-500">Preju√≠zo M√°x.</div>
                                        <div id="metricMaxLoss" class="font-medium">R$ -10,42</div>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded">
                                        <div class="text-xs text-gray-500">Ponto de Equil√≠brio</div>
                                        <div id="metricBE" class="font-medium">R$ 89,58 / R$ 110,42</div>
                                    </div>
                                </div>

                                <h4 class="text-md font-semibold mb-2">Pernas da Estrat√©gia</h4>
                                <div class="overflow-auto max-h-48 border rounded">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-100 text-gray-700">
                                            <tr>
                                                <th class="px-2 py-2 text-left">Tipo</th>
                                                <th class="px-2 py-2">A√ß√£o</th>
                                                <th class="px-2 py-2">Strike</th>
                                                <th class="px-2 py-2">Pr√™mio</th>
                                                <th class="px-2 py-2">Qtd.</th>
                                                <th class="px-2 py-2">Custo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="strategyLegs">
                                            <!-- Linhas populadas via JS -->
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mt-4 flex gap-2">
                                    <button id="exportExcelBtn" class="ml-auto bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Exportar</button>
                                    <button id="clearSelectionBtn" class="bg-gray-200 px-4 py-2 rounded">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <!-- Elementos ocultos esperados pelo JS (compatibilidade) -->
    <div id="loadingIndicator" class="hidden"></div>
    <div id="controls" class="hidden"></div>
    <div id="tableWrapper" class="hidden"></div>
    <table id="optionsTable" class="hidden">
        <tbody id="tableBody"></tbody>
    </table>
    
    <!-- Elementos de entrada para a aba antigo (usados pelo calculateAndRenderStrategy) -->
    <input id="strike1" type="hidden" value="140" />
    <input id="premium1" type="hidden" value="8" />
    <input id="strike2" type="hidden" value="150" />
    <input id="premium2" type="hidden" value="3" />
    <div id="rowCount" class="hidden"></div>
    <input id="filterTicker" type="hidden" />
    <select id="filterType" class="hidden"></select>

    <script>
        // Mapeamento das colunas
        const columns = [
            "idAcao", "ticker", "vencimento", "diasUteis", "tipo", "strike", "premioPct", 
            "volImplicita", "delta", "gamma", "theta", "vega", "dataHora"
        ];
        const displayColumns = columns.slice(0, -1);

        // =========================================================================
        // üö® DADOS DE EXEMPLO ATUALIZADOS (FALLBACK) üö®
        // =========================================================================
        const MOCK_CSV_DATA = [
            "idAcao,ticker,vencimento,diasUteis,tipo,strike,premioPct,volImplicita,delta,gamma,theta,vega,dataHora", 
            "BOVA11,BOVAA130,2026-01-02,22,CALL,130.00,20.00,1.4600,0.0009,0.0324,-0.0001,0.0104,26/11/2025",
            "BOVA11,BOVAA140,2026-01-16,32,CALL,140.00,8.00,1.4100,0.0009,0.0274,-0.0001,0.0118,26/11/2025",
            "BOVA11,BOVAM140,2026-01-16,32,PUT,140.00,0.96,1.6900,0.0002,0.0273,-0.0208,0.0141,26/11/2025",
            "BOVA11,BOVAA150,2026-01-16,32,CALL,150.00,3.00,1.4200,0.0008,0.0314,-0.0001,0.0137,26/11/2025",
            "BOVA11,BOVAM150,2026-01-16,32,PUT,150.00,1.10,1.6700,0.0002,0.0303,-0.0212,0.0155,26/11/2025",
            "BOVA11,BOVAA160,2026-03-20,74,CALL,160.00,1.00,1.3800,0.0012,0.0380,-0.0002,0.0210,26/11/2025",
            "BOVA11,BOVAM160,2026-03-20,74,PUT,160.00,2.50,1.6000,0.0004,0.0400,-0.0250,0.0280,26/11/2025",
            "BOVA11,BOVAB170,2026-05-15,116,CALL,170.00,0.50,1.3500,0.0018,0.0450,-0.0003,0.0350,26/11/2025",
            "BOVA11,BOVAI170,2026-05-15,116,PUT,170.00,4.00,1.5500,0.0006,0.0500,-0.0300,0.0400,26/11/2025",
        ];
        // =========================================================================

        let optionsData = []; 
        let currentData = [];
        let sortColumn = 'strike'; 
        let sortDirection = 'asc'; 
        let payoffChartInstance = null; // Inst√¢ncia do Chart.js

        // Elementos de UI
        const tableView = document.getElementById('tableView');
        const strategyView = document.getElementById('strategyView');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tabTable = document.getElementById('tabTable');
        const tabStrategy = document.getElementById('tabStrategy');

        // --- Fun√ß√µes de Utilit√°rios CSV (substitu√≠das por vers√µes robustas) ---

        // Remove BOM e normaliza quebras
        function csvTextToLines(text) {
	// Remove BOM (se existir)
	if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
	// Normaliza finais de linha
	const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
	// Quebra em linhas, preservando poss√≠veis quebras dentro de aspas ser√° tratado pelo parser de linha
	return normalized.split('\n').map(l => l.trim()).filter(l => l !== '');
}

// Detecta delimitador a partir da primeira linha (header)
function detectDelimiter(headerLine) {
	if (!headerLine) return ',';
	const commaCount = (headerLine.match(/,/g) || []).length;
	const semicolonCount = (headerLine.match(/;/g) || []).length;
	// Se houver mais ponto-e-v√≠rgula que v√≠rgula, escolhe ';' (comum em Excel/PT-BR)
	return semicolonCount > commaCount ? ';' : ',';
}

// Parser de uma linha CSV considerando aspas (retorna array de campos)
function parseCSVLine(line, delimiter = ',') {
	const fields = [];
	let cur = '';
	let inQuotes = false;
	for (let i = 0; i < line.length; i++) {
		const ch = line[i];
		if (ch === '"') {
			// Lookahead para dupla-aspas que representam aspas literais
			if (inQuotes && line[i+1] === '"') {
				cur += '"';
				i++; // pula a segunda aspas
			} else {
				inQuotes = !inQuotes;
			}
		} else if (ch === delimiter && !inQuotes) {
			fields.push(cur);
			cur = '';
		} else {
			cur += ch;
		}
	}
	fields.push(cur);
	return fields.map(f => f.trim());
}

// Converte string num√©rica BR/EN para number
function parseNumberFromString(value) {
	if (value === null || value === undefined || value === '') return NaN;
	// Remove espa√ßos
	let s = String(value).trim();
	// Se cont√©m apenas -, + ou n√£o √© num√©rico, deixa parseFloat normal lidar
	// Detecta formato com ponto-e-v√≠rgula ou v√≠rgula decimal: remove pontos de milhar e troca v√≠rgula por ponto
	// Ex: "1.234,56" -> "1234.56"
	// Tamb√©m lida com "1,234.56" (EN) conservadoramente: remove ',' se houver '.' depois
	if (s.indexOf(',') > -1 && s.indexOf('.') > -1) {
		// decide qual √© separador decimal pelo √∫ltimo caractere entre ',' e '.'
		if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
			s = s.replace(/\./g, '').replace(',', '.');
		} else {
			s = s.replace(/,/g, '');
		}
	} else if (s.indexOf(',') > -1) {
		s = s.replace(/\./g, '').replace(',', '.');
	} else {
		s = s.replace(/,/g, '');
	}
	const n = parseFloat(s);
	return isNaN(n) ? NaN : n;
}

// Parseia o CSV usando header real e mapeia para as colunas esperadas
function parseData(dataArray) {
	if (!dataArray || dataArray.length === 0) return [];
	// usa primeira linha como header
	const headerLine = dataArray[0];
	const delimiter = detectDelimiter(headerLine);
	const headerFields = parseCSVLine(headerLine, delimiter).map(h => h.replace(/"/g, '').trim());

	// cria mapa de √≠ndice por nome de coluna (case-insensitive, busca por inclus√£o)
	const headerIndexMap = {};
	headerFields.forEach((h, idx) => {
		headerIndexMap[h.toLowerCase()] = idx;
	});

	// fun√ß√£o auxiliar para achar √≠ndice de uma coluna esperada (por equival√™ncia simples)
	function findIndexForCol(colName) {
		const target = colName.toLowerCase();
		// busca exata
		for (const h of Object.keys(headerIndexMap)) {
			if (h === target) return headerIndexMap[h];
		}
		// busca por inclus√£o (ex: 'strike' dentro de 'Strike')
		for (const h of Object.keys(headerIndexMap)) {
			if (h.includes(target) || target.includes(h)) return headerIndexMap[h];
		}
		return -1;
	}

	const parsed = [];
	// percorre linhas de dados
	for (let r = 1; r < dataArray.length; r++) {
		const line = dataArray[r];
		if (!line || !line.trim()) continue;
		const values = parseCSVLine(line, delimiter).map(v => v.replace(/^"|"$/g, '').trim());
		// monta o objeto conforme nosso conjunto de colunas esperado
		const row = {};
		let hasTicker = false;
		columns.forEach(col => {
			const idx = findIndexForCol(col);
			let raw = (idx >= 0 && idx < values.length) ? values[idx] : '';
			if (["diasUteis", "strike", "premioPct", "volImplicita", "delta", "gamma", "theta", "vega"].includes(col)) {
				row[col] = parseNumberFromString(raw);
			} else {
				row[col] = raw || '';
			}
			if (col === 'ticker' && row[col]) hasTicker = true;
		});
		// valida√ß√£o simples: ticker e strike presentes
		if (hasTicker) parsed.push(row);
	}
	return parsed;
}

// --- Fun√ß√µes da Tabela ---

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const fragment = document.createDocumentFragment();

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = item.tipo === 'CALL' ? 'call-row hover:bg-green-200 transition duration-150' : 'put-row hover:bg-red-200 transition duration-150';
                
                displayColumns.forEach(col => {
                    const cell = row.insertCell();
                    cell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-800';
                    
                    let value = item[col];
                    
                    if (typeof value === 'number') {
                        let textValue;
                        
                        // [CORRIGIDO] Usar Intl.NumberFormat para formata√ß√£o monet√°ria (pt-BR)
                        const formatter = new Intl.NumberFormat('pt-BR', {
                            minimumFractionDigits: col === 'strike' ? 4 : (col === 'premioPct' ? 2 : 4),
                            maximumFractionDigits: col === 'strike' ? 4 : (col === 'premioPct' ? 2 : 4),
                            useGrouping: true,
                        });

                        if (col === 'strike') { 
                            textValue = `R$ ${formatter.format(value)}`;
                            cell.className += ' text-right font-bold tabular-nums';
                        } else if (col === 'premioPct') { 
                            textValue = `R$ ${formatter.format(value)}`;
                            cell.className += ' text-right font-bold tabular-nums text-indigo-700';
                        } else if (col === 'diasUteis') {
                            textValue = String(Math.round(value));
                            cell.className += ' text-center font-mono';
                        } else {
                            // Greeks (Delta, Gamma, Theta, Vega)
                            textValue = formatter.format(value);
                            cell.className += ' text-right tabular-nums';
                            
                            if (col === 'theta' && value < 0) {
                                cell.className += ' text-red-600';
                            } else if (col === 'vega' && value > 0) {
                                cell.className += ' text-blue-600';
                            }
                        }
                        cell.textContent = textValue;
                    } else if (col === 'vencimento') {
                        cell.className += ' font-mono text-center';
                        cell.textContent = value;
                    } else {
                        cell.textContent = value;
                        if (col === 'ticker') cell.className += ' font-bold text-gray-900';
                        if (col === 'tipo') cell.className += ' text-center';
                    }
                });
                fragment.appendChild(row);
            });

            tableBody.appendChild(fragment);
            document.getElementById('rowCount').textContent = `Linhas exibidas: ${data.length} de ${optionsData.length}`;
        }
        
        function filterTable() {
            const tickerFilter = document.getElementById('filterTicker').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;

            let filteredData = optionsData.filter(item => {
                const matchesType = typeFilter === '' || item.tipo === typeFilter;
                const strikeString = String(item.strike).replace('.', ',');
                const matchesTicker = item.ticker.toLowerCase().includes(tickerFilter) || 
                                             strikeString.includes(tickerFilter.replace(',', '.')) ||
                                             item.vencimento.includes(tickerFilter);
                
                return matchesType && matchesTicker;
            });
            
            if (sortColumn) {
                filteredData = sortData(filteredData, sortColumn, sortDirection);
            }

            currentData = filteredData;
            renderTable(currentData);
        }
        
        function sortData(data, column, direction) {
            return data.sort((a, b) => {
                const aValue = a[column];
                const bValue = b[column];

                if (typeof aValue === 'number' && typeof bValue === 'number') {
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                }
                
                const aStr = String(aValue).toLowerCase();
                const bStr = String(bValue).toLowerCase();

                if (aStr < bStr) return direction === 'asc' ? -1 : 1;
                if (aStr > bStr) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function setupSorting() {
            document.querySelectorAll('#optionsTable th').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return; 

                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'asc';
                    }
                    
                    document.querySelectorAll('#optionsTable th').forEach(th => {
                        th.textContent = th.textContent.replace(/[\u25B2\u25BC]/g, '').trim(); 
                    });

                    const indicator = sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
                    header.textContent += indicator;
                    filterTable(); 
                });
            });
        }
        
        // --- Fun√ß√µes de Payoff e Gr√°fico ---

        /**
         * Calcula o payoff de uma √∫nica Call/Put.
         */
        function calculateSinglePayoff(type, strike, premium, finalPrice, position) {
            let intrinsicValue;
            
            if (type === 'CALL') {
                intrinsicValue = Math.max(0, finalPrice - strike);
            } else if (type === 'PUT') {
                intrinsicValue = Math.max(0, strike - finalPrice);
            } else {
                return 0; // Tipo inv√°lido
            }

            if (position === 'LONG') {
                // Lucro/Preju√≠zo = Valor Intr√≠nseco - Pr√™mio Pago
                return intrinsicValue - premium;
            } else if (position === 'SHORT') {
                // Lucro/Preju√≠zo = Pr√™mio Recebido - Valor Intr√≠nseco
                return premium - intrinsicValue;
            }
            return 0;
        }

        /**
         * Calcula o Payoff da Trava de Alta (Bull Call Spread): Long Call K1 + Short Call K2
         */
        function calculateStrategyPayoff(K1, P1, K2, P2, finalPrice) {
            const payoffLongCall = calculateSinglePayoff('CALL', K1, P1, finalPrice, 'LONG');
            const payoffShortCall = calculateSinglePayoff('CALL', K2, P2, finalPrice, 'SHORT');
            return payoffLongCall + payoffShortCall;
        }

        /**
         * Renderiza o Gr√°fico de Payoff
         */
        function renderPayoffChart(K1, P1, K2, P2) {
            if (payoffChartInstance) {
                payoffChartInstance.destroy(); // Destr√≥i inst√¢ncia anterior, se existir
            }

            const ctx = document.getElementById('payoffChart').getContext('2d');
            
            // Determina a faixa de pre√ßos a ser plotada (10% abaixo do K1 at√© 10% acima do K2)
            const minPrice = Math.min(K1, K2) * 0.9;
            const maxPrice = Math.max(K1, K2) * 1.1;
            const step = (maxPrice - minPrice) / 100; // 100 pontos para suavizar a linha
            
            const prices = [];
            const payoffs = [];

            for (let p = minPrice; p <= maxPrice; p += step) {
                const payoff = calculateStrategyPayoff(K1, P1, K2, P2, p);
                prices.push(parseFloat(p.toFixed(2))); // Pre√ßo final (X)
                payoffs.push(parseFloat(payoff.toFixed(2))); // Lucro/Preju√≠zo (Y)
            }
            
            // Calculo dos pontos de resumo
            const custoLiquido = P1 - P2;
            const maxProfit = K2 - K1 - custoLiquido;
            const maxLoss = -custoLiquido;
            const breakeven = K1 + custoLiquido; // Ponto de equil√≠brio (Payoff = 0)
            
            // [CORRIGIDO] Usar Intl.NumberFormat para resumo da estrat√©gia
            const currencyFormatter = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            });

            // Exibir resumo da estrat√©gia
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `
                <p><strong>Custo L√≠quido:</strong> ${currencyFormatter.format(custoLiquido)}</p>
                <p><strong>Lucro M√°ximo:</strong> ${currencyFormatter.format(maxProfit)} (Acima de K2)</p>
                <p><strong>Preju√≠zo M√°ximo:</strong> ${currencyFormatter.format(maxLoss)} (Abaixo de K1)</p>
                <p><strong>Ponto de Equil√≠brio (Breakeven):</strong> ${currencyFormatter.format(breakeven)}</p>
            `;
            summaryDiv.classList.remove('hidden');

            // --- Configura√ß√£o do Chart.js ---
            payoffChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices,
                    datasets: [{
                        label: 'Payoff da Trava de Alta (Bull Call Spread)',
                        data: payoffs,
                        borderColor: '#3b82f6', // Azul principal
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Curva de Payoff no Vencimento'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Pre√ßo do Ativo no Vencimento (R$)'
                            },
                            // Garantir que os Strikes K1 e K2 sejam vis√≠veis
                            min: minPrice,
                            max: maxPrice,
                            ticks: {
                                callback: function(value) {
                                    // [CORRIGIDO] Usar v√≠rgula como separador decimal para o eixo X
                                    const label = value.toFixed(2).replace('.', ',');
                                    
                                    if (value === K1) return `K1 (${label})`;
                                    if (value === K2) return `K2 (${label})`;
                                    if (value.toFixed(2) === breakeven.toFixed(2)) return `BE (${label})`; // Compara strings formatadas para evitar float errors
                                    
                                    // Exibe ticks n√£o-chave com duas casas decimais formatadas para PT-BR
                                    return value.toFixed(2).replace('.', ',');
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Lucro / Preju√≠zo (R$)'
                            },
                            beginAtZero: false,
                            grid: {
                                // Linha central em y=0
                                drawOnChartArea: true,
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return '#ef4444'; // Cor vermelha para o zero
                                    }
                                    return '#e5e7eb'; // Cor padr√£o
                                },
                                lineWidth: function(context) {
                                    return context.tick.value === 0 ? 2 : 1; 
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Lida com a entrada do usu√°rio e inicia o c√°lculo/renderiza√ß√£o da estrat√©gia.
         */
        function calculateAndRenderStrategy() {
            // Se os inputs antigos (strike1-2, premium1-2) n√£o tiverem valores,
            // use valores padr√£o da UI nova
            let strike1Val = parseFloat(document.getElementById('strike1').value) || 140;
            let premium1Val = parseFloat(document.getElementById('premium1').value) || 8;
            let strike2Val = parseFloat(document.getElementById('strike2').value) || 150;
            let premium2Val = parseFloat(document.getElementById('premium2').value) || 3;
            
            const summaryDiv = document.getElementById('summary');
            
            if (isNaN(strike1Val) || isNaN(premium1Val) || isNaN(strike2Val) || isNaN(premium2Val)) {
                summaryDiv.innerHTML = `<span class="text-red-600">Erro:</span> Por favor, preencha todos os campos com valores num√©ricos.`;
                summaryDiv.classList.remove('hidden');
                return;
            }

            if (strike1Val >= strike2Val) {
                summaryDiv.innerHTML = `<span class="text-red-600">Erro:</span> Para Trava de Alta (Bull Call Spread), o Strike K1 (Long) deve ser **menor** que o Strike K2 (Short).`;
                summaryDiv.classList.remove('hidden');
                return;
            }

            renderPayoffChart(strike1Val, premium1Val, strike2Val, premium2Val);
        }

        // --- Fun√ß√µes de Inicializa√ß√£o e Visualiza√ß√£o ---

        // Tenta dividir o CSV em linhas respeitando aspas (simples tratamento)
        function csvTextToLines(text) {
            const lines = [];
            let cur = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                if (ch === '"') {
                    inQuotes = !inQuotes;
                    cur += ch;
                } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
                    // trata quebra de linha (pula \r, usa \n como separador)
                    if (ch === '\n') {
                        lines.push(cur);
                        cur = '';
                    }
                } else {
                    cur += ch;
                }
            }
            if (cur.trim() !== '') lines.push(cur);
            return lines.map(l => l.replace(/\r/g, '').trim()).filter(l => l !== '');
        }

        // L√™ CSV a partir de um File (input file)
        function handleLocalFile(file) {
            const reader = new FileReader();
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.innerHTML = `Lendo arquivo local: ${file.name}`;
            reader.onload = (e) => {
                const text = String(e.target.result || '');
                processCsvText(text);
            };
            reader.onerror = (err) => {
                console.error('Erro ao ler arquivo local:', err);
                loadingIndicator.innerHTML = `<span class="text-red-600">Erro ao ler arquivo local</span>`;
            };
            reader.readAsText(file, 'utf-8');
        }

        // Processa o texto CSV e renderiza a tabela (fluxo centralizado)
        function processCsvText(csvText) {
            const rawDataArray = csvTextToLines(csvText);
            if (!rawDataArray || rawDataArray.length === 0) {
                console.error("Nenhuma linha de dados v√°lida foi carregada.");
                loadingIndicator.innerHTML = `<span class="text-red-600 font-bold">ERRO FATAL:</span> Falha ao carregar os dados.`;
                return;
            }
            optionsData = parseData(rawDataArray);
            if (optionsData.length === 0) {
                console.error("Nenhuma linha de dados v√°lida ap√≥s parsing.");
                loadingIndicator.innerHTML = `<span class="text-red-600 font-bold">ERRO FATAL:</span> Falha ao parsear os dados.`;
                return;
            }
            currentData = sortData([...optionsData], sortColumn, sortDirection);
            renderTable(currentData);
            setupSorting();
            const strikeHeader = document.querySelector('[data-column="strike"]');
            if (strikeHeader) strikeHeader.textContent += ' ‚ñ≤';
            loadingIndicator.classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('tableWrapper').classList.remove('hidden');
            calculateAndRenderStrategy();
        }

        async function fetchDataAndRender() {
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.innerHTML = 'Tentando carregar opcoes_final_tratado.csv...';

            // Tenta v√°rios caminhos relativos (quando servido via HTTP)
            const candidates = [
                './opcoes_final_tratado.csv',
                '/opcoes_final_tratado.csv',
                './src/opcoes_final_tratado.csv',
                '../opcoes_final_tratado.csv',
                'opcoes_final_tratado.csv'
            ];
            let csvText = null;
            for (const url of candidates) {
                try {
                    const resp = await fetch(url, { cache: 'no-store' });
                    if (resp.ok) {
                        csvText = await resp.text();
                        console.log(`CSV carregado de: ${url}`);
                        break;
                    } else {
                        console.warn(`N√£o encontrado em ${url} (status ${resp.status})`);
                    }
                } catch (err) {
                    console.warn(`Erro ao buscar ${url}:`, err && err.message ? err.message : err);
                }
            }

            // Se n√£o carregou, usa fallback MOCK mas informa ao usu√°rio e permite carregar localmente
            if (!csvText) {
                console.warn('CSV real n√£o encontrado ‚Äî usando dados mockados em mem√≥ria. Voc√™ pode carregar o CSV gerado usando o bot√£o "Carregar CSV".');
                loadingIndicator.innerHTML = 'CSV n√£o encontrado via HTTP. Use o bot√£o "Carregar CSV" para selecionar o arquivo gerado localmente ou continue com mocks.';
                csvText = MOCK_CSV_DATA.join('\n');
            }

            // Converte CSV para array de linhas (tratamento simples que respeita aspas)
            processCsvText(csvText);
        }

        // Hook do input file e bot√£o
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('csvFileInput');
            const btn = document.getElementById('loadCsvBtn');
            if (input) {
                input.addEventListener('change', (ev) => {
                    const files = ev.target.files;
                    if (files && files.length > 0) {
                        handleLocalFile(files[0]);
                    }
                });
            }
            if (btn) {
                btn.addEventListener('click', () => {
                    if (input && input.files && input.files.length > 0) {
                        handleLocalFile(input.files[0]);
                    } else {
                        alert('Selecione um arquivo .csv usando o campo √† esquerda antes de clicar em Carregar CSV.');
                    }
                });
            }
        });

        /**
         * Alterna entre as views de Tabela e Estrat√©gia
         */
        function switchView(view) {
            if (view === 'table') {
                tableView.classList.remove('hidden');
                strategyView.classList.add('hidden');
                tabTable.classList.add('tab-active');
                tabTable.classList.remove('tab-inactive');
                tabStrategy.classList.remove('tab-active');
                tabStrategy.classList.add('tab-inactive');
            } else {
                tableView.classList.add('hidden');
                strategyView.classList.remove('hidden');
                tabStrategy.classList.add('tab-active');
                tabStrategy.classList.remove('tab-inactive');
                tabTable.classList.remove('tab-active');
                tabTable.classList.add('tab-inactive');
                // Garante que o gr√°fico seja re-renderizado ao mudar para a view
                calculateAndRenderStrategy(); 
            }
        }
 
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', fetchDataAndRender);
    </script>
</body>
</html>